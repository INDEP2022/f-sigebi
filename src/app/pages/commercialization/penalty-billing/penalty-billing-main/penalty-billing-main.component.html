<app-card [header]="true">
  <div class="ch-content" header>
    <h5 class="title">
      Facturación de Penalizaciones
      <!-- {{ layout == 'penalty' ? 'Facturación de Penalizaciones' : '' }}
      {{ layout == 'bases-sales' ? 'Facturación de Venta de Bases' : '' }} -->
    </h5>
  </div>
  <div body>
    <form class="form-material" [formGroup]="billingForm">
      <div class="row mt-1 mb-5">
        <div class="col-md-9">
          <div class="row mt-5 d-flex justify-content-center">
            <div class="col-md-12">
              <form-field [control]="billingForm.get('eventId')">
                <ngx-select
                  (fetchItems)="getEventData($event)"
                  [data]="dataEvent"
                  [form]="billingForm"
                  value="id_evento"
                  bindLabel="cve_proceso"
                  label="Evento"
                  [control]="'eventId'"
                  [searchOnInit]="true"
                  [searchable]="true"
                  (change)="checkEvent($event)"
                  termMaxLength="30"
                  [labelTemplate]="eventT"
                  [optionTemplate]="eventCv">
                </ngx-select>
                <ng-template #eventT let-item="item">
                  {{ item.id_evento }} - {{ item.cve_proceso }}
                </ng-template>
                <ng-template #eventCv let-item="item">
                  <div [title]="item.id_evento + '-' + item.cve_proceso">
                    {{ item.id_evento }} - {{ item.cve_proceso }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <div class="col-md-6">
              <form-field [control]="billingForm.get('batchId')">
                <ngx-select
                  (fetchItems)="getLoteByEvent($event)"
                  [data]="dataLote"
                  [form]="billingForm"
                  value="lotPublic"
                  bindLabel="description"
                  label="Lote"
                  [control]="'batchId'"
                  [searchOnInit]="true"
                  [searchable]="false"
                  termMaxLength="30"
                  (change)="getDataLote($event)"
                  [labelTemplate]="lotE"
                  [optionTemplate]="lotDesc">
                </ngx-select>
                <ng-template #lotE let-item="item">
                  {{ item.lotPublic }} - {{ item.description }}
                </ng-template>
                <ng-template #lotDesc let-item="item">
                  <div [title]="item.lotPublic + '-' + item.description">
                    {{ item.lotPublic }} - {{ item.description }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field
                [control]="billingForm.get('eventDate')"
                label="Fecha Evento">
                <input
                  type="text"
                  formControlName="eventDate"
                  class="form-control"
                  [maxDate]="maxDate"
                  bsDatepicker
                  [bsConfig]="{ dateInputFormat: 'DD/MM/YYYY' }" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('series')" label="Serie">
                <input
                  type="text"
                  formControlName="series"
                  class="form-control"
                  oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('Invoice')" label="Folio">
                <input
                  type="text"
                  formControlName="Invoice"
                  class="form-control"
                  oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field
                [control]="billingForm.get('factstatusId')"
                label="Estatus">
                <input
                  type="text"
                  formControlName="factstatusId"
                  class="form-control"
                  oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field
                [control]="billingForm.get('vouchertype')"
                label="Tipo">
                <input
                  type="text"
                  formControlName="vouchertype"
                  class="form-control"
                  oninput="if(this.value.length > 4) this.value = this.value.slice(0, 4)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field
                [control]="billingForm.get('impressionDate')"
                label="Fecha Impresión">
                <input
                  type="text"
                  formControlName="impressionDate"
                  class="form-control"
                  [maxDate]="maxDate"
                  bsDatepicker
                  [bsConfig]="{ dateInputFormat: 'DD/MM/YYYY' }" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('cvman')">
                <ngx-select
                  (fetchItems)="getTransferentData($event)"
                  label="Transferente"
                  [data]="dataTransferent"
                  [form]="billingForm"
                  value="cvman"
                  bindLabel="nameTransferent"
                  [control]="'cvman'"
                  [searchOnInit]="true"
                  [searchable]="true"
                  termMaxLength="30"
                  (change)="selectedTrans($event)"
                  [labelTemplate]="trans"
                  [optionTemplate]="transDesc">
                </ngx-select>
                <ng-template #trans let-item="item">
                  {{ item.cvman }} - {{ item.nameTransferent }}
                </ng-template>
                <ng-template #transDesc let-item="item">
                  <div [title]="item.cvman">
                    {{ item.cvman }} - {{ item.nameTransferent }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('delegationNumber')">
                <ngx-select
                  [data]="delegations"
                  [searchOnInit]="true"
                  (fetchItems)="getDelegation($event)"
                  [form]="billingForm"
                  value="id"
                  bindLabel="description"
                  label="Delegación"
                  [control]="'delegationNumber'"
                  [searchable]="false"
                  [labelTemplate]="delg"
                  [optionTemplate]="delgd">
                </ngx-select>
                <ng-template #delg let-item="item">
                  {{ item.id }} - {{ item.description }}
                </ng-template>
                <ng-template #delgd let-item="item">
                  <div [title]="item.id + '-' + item.description">
                    {{ item.id }} - {{ item.description }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('Iauthorize')">
                <ngx-select
                  (fetchItems)="getComerClientsData($event)"
                  label="Autoriza"
                  [data]="dataClient"
                  [form]="billingForm"
                  value="reasonName"
                  bindLabel="reasonName"
                  [control]="'Iauthorize'"
                  [searchOnInit]="true"
                  [searchable]="true"
                  termMaxLength="30"
                  [labelTemplate]="auth"
                  [optionTemplate]="authorizeDesc">
                </ngx-select>
                <ng-template #auth let-item="item">
                  {{ item.reasonName }}
                </ng-template>
                <ng-template #authorizeDesc let-item="item">
                  <div [title]="item.reasonName + ' - ' + item.rfc">
                    {{ item.reasonName }} - {{ item.rfc }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <div class="col-sm-12 col-md-12">
              <form-field
                [control]="billingForm.get('description')"
                label="Descripción">
                <textarea
                  rows="3"
                  formControlName="description"
                  class="form-control">
                </textarea>
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('customer')">
                <ngx-select
                  (fetchItems)="getComerClientsData2($event)"
                  label="Cliente"
                  [data]="dataClient2"
                  [form]="billingForm"
                  value="reasonName"
                  bindLabel="reasonName"
                  [control]="'customer'"
                  [searchOnInit]="true"
                  [searchable]="true"
                  termMaxLength="30"
                  (change)="setDataClient($event)"
                  [labelTemplate]="cliented"
                  [optionTemplate]="clientDesc">
                </ngx-select>
                <ng-template #cliented let-item="item">
                  {{ item.reasonName }}
                </ng-template>
                <ng-template #clientDesc let-item="item">
                  <div [title]="item.reasonName + ' - ' + item.rfc">
                    {{ item.reasonName }} - {{ item.rfc }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('street')" label="Calle">
                <input
                  type="text"
                  formControlName="street"
                  class="form-control"
                  oninput="if(this.value.length > 80) this.value = this.value.slice(0, 80)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field
                [control]="billingForm.get('cologne')"
                label="Colonia">
                <input
                  type="text"
                  formControlName="cologne"
                  class="form-control"
                  oninput="if(this.value.length > 60) this.value = this.value.slice(0, 60)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('rfc')" label="R.F.C.">
                <input
                  type="text"
                  formControlName="rfc"
                  class="form-control"
                  oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field
                [control]="billingForm.get('municipality')"
                label="Municipio Delegación">
                <input
                  type="text"
                  formControlName="municipality"
                  class="form-control"
                  oninput="if(this.value.length > 30) this.value = this.value.slice(0, 30)" />
              </form-field>
            </div>
            <div class="col-sm-12 col-md-6">
              <form-field [control]="billingForm.get('state')" label="Estado">
                <input
                  type="text"
                  formControlName="state"
                  class="form-control"
                  oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
              </form-field>
            </div>
            <div class="col-sm-4 col-md-3">
              <form-field [control]="billingForm.get('cop')" label="C.P.">
                <input
                  type="number"
                  formControlName="cop"
                  class="form-control"
                  oninput="if(this.value.length > 6) this.value = this.value.slice(0, 6)" />
              </form-field>
            </div>
            <div class="col-sm-4 col-md-3">
              <form-field [control]="billingForm.get('price')" label="Precio">
                <input
                  type="number"
                  formControlName="price"
                  class="form-control"
                  min="0"
                  oninput="if(this.value.length > 21) this.value = this.value.slice(0, 21)" />
              </form-field>
            </div>
            <div class="col-sm-4 col-md-3">
              <form-field [control]="billingForm.get('vat')" label="IVA">
                <input
                  type="number"
                  formControlName="vat"
                  class="form-control"
                  min="0"
                  oninput="if(this.value.length > 13) this.value = this.value.slice(0, 13)" />
              </form-field>
            </div>
            <div class="col-sm-4 col-md-3">
              <form-field [control]="billingForm.get('total')" label="Total">
                <input
                  type="number"
                  formControlName="total"
                  class="form-control"
                  min="0"
                  oninput="if(this.value.length > 21) this.value = this.value.slice(0, 21)" />
              </form-field>
            </div>
            <div class="col-md-12">
              <div class="d-flex justify-content-center">
                <div class="d-inline">
                  <confirm-button
                    [className]="'btn-primary mr-2'"
                    [disabled]="!billingForm.valid"
                    [btnSmall]="true"
                    [loading]="loading"
                    (confirm)="saveData()"></confirm-button>
                  <confirm-button
                    [className]="'btn-primary mr-2'"
                    [icon]="'bx bx-search-alt'"
                    [loadingText]="'Buscando'"
                    text="Buscar"
                    [btnSmall]="true"
                    [loading]="loadingSearch"
                    (confirm)="searchData()"></confirm-button>
                  <!-- <button class="btn btn-danger btn-sm active mr-2" (click)="resetData()">
                    Limpiar <i class="fas fa-eraser"> </i>
                  </button> -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="row">
            <div class="col-12">
              <div class="d-inline">
                <button
                  type="button"
                  class="btn btn-info btn-sm active w-100 mb-3"
                  (click)="newInvoice()">
                  Nuevo <i class="bx bx-plus bx-sm float-icon"></i>
                </button>
              </div>
            </div>
            <div class="col-12">
              <button
                class="btn btn-sm btn-primary btn-block active me-2 mb-3"
                (click)="generateFolios()">
                Genera Folios <i class="fa fa-file" aria-hidden="true"></i>
              </button>
            </div>
            <div class="col-12">
              <button
                class="btn btn-sm btn-info btn-block active me-2 mb-3"
                (click)="openFolioModal()"
                [disabled]="">
                Asig. Manual Folios
                <i class="fa fa-file" aria-hidden="true"></i>
              </button>
            </div>
            <div class="col-12">
              <button
                class="btn btn-red btn-sm active me-2 mb-3 w-100"
                (click)="deleteFolios()"
                [disabled]="">
                Eliminar Folios <i class="fa fa-trash" aria-hidden="true"></i>
              </button>
            </div>
            <!-- <div class="col-12">
              <button
                class="btn btn-sm btn-secondary btn-block active me-2 mb-3"
                (click)="getImage()">
                Obtener Imagen <i class="fa fa-image" aria-hidden="true"></i>
              </button>
            </div> -->
            <div class="col-12">
              <button
                class="btn btn-sm btn-success btn-block active me-2 mb-3"
                (click)="openPrevInvoice()">
                Visualizar e Imprimir Factura
                <i class="fa fa-print" aria-hidden="true"></i>
              </button>
            </div>
            <div class="col-12">
              <button
                class="btn btn-sm btn-danger btn-block active me-2 mb-3"
                (click)="cancelInvoice()">
                Cancelar Factura <i class="fa fa-file" aria-hidden="true"></i>
              </button>
            </div>
            <div class="col-sm-12 col-md-12 mt-3" *ngIf="displayCancel">
              <form-field [control]="billingForm.get('causerebillId')">
                <ngx-select
                  (fetchItems)="getRebillData($event)"
                  label="Causa Cancelación"
                  [data]="dataRebill"
                  [form]="billingForm"
                  value="id"
                  bindLabel="id"
                  [control]="'causerebillId'"
                  [searchOnInit]="true"
                  [searchable]="true"
                  (change)="setRefacture($event)"
                  termMaxLength="30"
                  [labelTemplate]="rebill"
                  [optionTemplate]="rebillDesc">
                </ngx-select>
                <ng-template #rebill let-item="item">
                  {{ item.id }} - {{ item.description }}
                </ng-template>
                <ng-template #rebillDesc let-item="item">
                  <div [title]="item.id + ' - ' + item.description">
                    {{ item.id }} - {{ item.description }}
                  </div>
                </ng-template>
              </form-field>
            </div>
          </div>
        </div>
      </div>
    </form>
  </div>
</app-card>
