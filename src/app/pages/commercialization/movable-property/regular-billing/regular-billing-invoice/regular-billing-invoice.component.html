<app-card [header]="false" [footer]="false">
  <div body style="margin-bottom: 0px !important">
    <accordion
      style="display: block; margin-bottom: 0px !important"
      [isAnimated]="true">
      <accordion-group
        id="testAcc"
        style="margin-bottom: 0px !important"
        [isOpen]="true"
        [class.disabled]="false">
        <div accordion-heading class="d-flex justify-content-between">
          <h5>ACCIONES</h5>
        </div>
        <form id="testBottomMargin" class="form-material" [formGroup]="form">
          <div class="row mt-2 justify-content-center text-center">
            <div class="col-12 col-md-3">
              <form-field [control]="form.get('event')" label="Evento">
                <input
                  type="number"
                  class="form-control"
                  formControlName="event"
                  oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)"
                  (blur)="formG.emit(form)" />
              </form-field>
            </div>
            <div class="col-12 col-md-3">
              <form-field [control]="form.get('idAllotment')" label="Lote">
                <input
                  type="number"
                  class="form-control"
                  formControlName="idAllotment"
                  oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)"
                  (blur)="formG.emit(form)" />
              </form-field>
            </div>
            <div class="col-12 col-md-3">
              <form-field [control]="form.get('date')" label="Fecha">
                <input
                  type="text"
                  class="form-control"
                  bsDatepicker
                  [bsConfig]="{
                    withTimepicker: true,
                    dateInputFormat: 'DD/MM/YYYY h:mm a',
                    keepDatepickerOpened: true
                  }"
                  formControlName="date" />
              </form-field>
              <!-- [bsConfig]="{ dateInputFormat: 'DD/MM/YYYY' }" -->
            </div>
          </div>
          <div class="row mt-4">
            <div class="col-3">
              <div class="row">
                <div class="col-12">
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading }"
                    [disabled]="btnLoading"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="generatePreFacture()">
                    Genera Prefacturas
                    <i *ngIf="!btnLoading" class="bx bxs-file"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [disabled]="buttons"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="openFolioModal()">
                    Asig. Manual Folios
                    <i class="bx bx-plus bx-sm float-icon"></i>
                  </button>
                  <!-- FALTA VALIDAR -->
                  <button
                    type="button"
                    class="btn btn-primary btn-sm btn-block active mr-2 mb-2"
                    (click)="clientSend()">
                    Atención a Clientes
                    <i class="fa fa-check" aria-hidden="true"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [disabled]="true"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="viewInvoice()">
                    Visualizar Factura
                    <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading2 }"
                    [disabled]="btnLoading2"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="imprimeInvoice()">
                    Imprime Factura
                    <i
                      *ngIf="!btnLoading2"
                      class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <form-check label="Solo Fact." for="label">
                    <input
                      id="label"
                      type="checkbox"
                      formControlName="check"
                      (change)="disabledButtons()" />
                  </form-check>
                </div>
              </div>
            </div>
            <div class="col-3">
              <div class="row">
                <div class="col-12">
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading3 }"
                    [disabled]="btnLoading3"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="updateData()">
                    Actualiza Datos
                    <i *ngIf="!btnLoading3" class="fas fa-sync-alt"> </i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [disabled]="buttons"
                    type="button"
                    class="btn btn-block btn-primary btn-sm active mr-2 mb-2"
                    (click)="sendPackage()">
                    Enviar Paquete <i class="bx bx-send"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading9 }"
                    [disabled]="btnLoading9"
                    type="button"
                    class="btn btn-block btn-primary btn-sm active mr-2 mb-2"
                    (click)="actMatricula()">
                    Act. Matrícula
                    <i *ngIf="!btnLoading9" class="fas fa-sync-alt"> </i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading14 }"
                    [disabled]="btnLoading14"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="viewAnexo()">
                    Visualiza Anexo
                    <i
                      *ngIf="!btnLoading14"
                      class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- FALTA VALIDAR -->
                  <button
                    [disabled]="buttons"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="impresionAnex()">
                    Imprime Anexo <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [disabled]="buttons"
                    type="button"
                    class="btn btn-danger btn-sm btn-block active mr-2 mb-2"
                    (click)="cancelInvoice()">
                    Cancelar Factura
                  </button>
                </div>
              </div>
            </div>
            <div class="col-3">
              <div class="row">
                <div class="col-12">
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading10 }"
                    [disabled]="btnLoading10"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="generateInvoice()">
                    Genera Folios
                    <!-- <i class="bx bxs-file"></i> -->
                  </button>
                  <!-- LISTO -->
                  <button
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="openURL()">
                    Generar CFDI
                    <!-- <i class="bx bxs-file"></i> -->
                  </button>
                  <!-- LISTO -->
                  <button
                    type="button"
                    class="btn btn-block btn-primary btn-sm active mr-2 mb-2"
                    (click)="track()">
                    Tracto S/P
                    <!-- <i class="bx bx-printer bx-sm float-icon"></i> -->
                  </button>
                  <!-- LISTO -->
                  <button
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="visualizarCR()">
                    Visualiza CR <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [disabled]="buttons"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="impresionCR()">
                    Imprime CR <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading13 }"
                    [disabled]="btnLoading13"
                    type="button"
                    class="btn btn-sm btn-block btn-success active mr-2 mb-2"
                    (click)="exportData()">
                    Exportar a Excel
                    <i
                      *ngIf="!btnLoading13"
                      class="bx bx-download float-icon"></i>
                  </button>
                </div>
              </div>
            </div>
            <div class="col-3">
              <div class="row">
                <div class="col-12">
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading8 }"
                    [disabled]="btnLoading8"
                    type="button"
                    class="btn btn-block btn-primary btn-sm active mr-2 mb-2"
                    (click)="allSelect()">
                    Selec. Todos
                    <i
                      *ngIf="!btnLoading8"
                      class="fas fa-edit bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [ngClass]="{ loading: btnLoading11 }"
                    [disabled]="true"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="removeInvoice()">
                    Eliminar Folios
                    <i
                      *nfIf="!btnLoading11"
                      class="fa fa-trash"
                      aria-hidden="true"></i>
                  </button>
                  <!-- FALTA VALIDAR -->
                  <button
                    (click)="printerMasivePDF()"
                    type="button"
                    class="btn btn-primary btn-block active btn-sm mr-2 mb-2">
                    Imprime Masivo .pdf
                    <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="visualizarCE()">
                    Visualiza CE <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                  <!-- LISTO -->
                  <button
                    [disabled]="buttons"
                    type="button"
                    class="btn btn-primary btn-block btn-sm active mr-2 mb-2"
                    (click)="impresionCE()">
                    Imprime CE <i class="bx bx-printer bx-sm float-icon"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div
            class="row justify-content-center text-center mt-4"
            *ngIf="isCancel">
            <!-- LISTO -->
            <div class="col-1 col-md-1">
              <button
                type="button"
                class="btn btn-block btn-primary btn-sm active mr-2"
                (click)="invoiceSP()">
                SP
              </button>
            </div>
            <div class="col-12 col-md-2">
              <!-- LISTO -->
              <form-field [control]="form.get('folio')" label="Folio SP">
                <input
                  type="number"
                  class="form-control"
                  formControlName="folio"
                  oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)"
                  (blur)="formG.emit(form)" />
              </form-field>
            </div>
            <div class="col-12 col-md-6">
              <!-- LISTO -->
              <form-field [control]="form.get('causerebillId')">
                <ngx-select
                  (fetchItems)="getRebillData($event)"
                  label="Causa Cancelación"
                  [data]="dataRebill"
                  [form]="form"
                  value="id"
                  bindLabel="id"
                  [control]="'causerebillId'"
                  [searchOnInit]="true"
                  [searchable]="false"
                  termMaxLength="30"
                  [labelTemplate]="rebill"
                  [optionTemplate]="rebillDesc"
                  (change)="setDataCause($event)"
                  typeToSearchText="No hay más resultados">
                </ngx-select>
                <ng-template #rebill let-item="item">
                  {{ item.id }} - {{ item.description }}
                </ng-template>
                <ng-template #rebillDesc let-item="item">
                  <div [title]="item.id + ' - ' + item.description">
                    {{ item.id }} - {{ item.description }}
                  </div>
                </ng-template>
              </form-field>
            </div>
            <!-- LISTO -->
            <div class="col-12 col-md-2">
              <button
                type="button"
                class="btn btn-block btn-primary btn-sm active"
                (click)="CancelInvoice()">
                Anular
              </button>
            </div>
          </div>
        </form>
      </accordion-group>
    </accordion>
  </div>
</app-card>

<div class="row">
  <div class="ch-content">
    <h5 class="title">PREFACTURAS DEL EVENTO</h5>
    <div class="row justify-content-end mr-3">
      <!-- [defaultColumns]="7" -->
      <!-- [leftList]="true" -->
      <app-columns-select
        [defaultColumns]="7"
        [(settings)]="settings"
        [leftList]="true"></app-columns-select>
    </div>
  </div>
  <div class="row pt-3">
    <form-loader *ngIf="loading"></form-loader>
    <div>
      <ng2-smart-table
        #myTable
        [ngStyle]="{
          height: loading ? '0px' : totalItems > 10 ? '600px' : 'auto'
        }"
        [attr.class]="'table-bordered table-responsive mb-4'"
        [settings]="settings"
        [source]="dataFilter"
        (userRowSelect)="getComerDetInvocie($event.data)">
      </ng2-smart-table>
    </div>
    <app-pagination
      [params]="paramsList"
      [limit]="limit"
      [pageSizeOptions]="[500]"
      [totalItems]="totalItems">
    </app-pagination>
  </div>

  <form class="form-material" [formGroup]="formFactura">
    <div class="row pt-5">
      <div class="col-md-2">
        <form-field [control]="formFactura.get('xLote')">
          <form-check id="checkbox_fcomer" label="X Lote" for="Xlote">
            <input
              id="Xlote"
              formControlName="xLote"
              class="form-control"
              type="checkbox" />
          </form-check>
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formFactura.get('order')" label="Ordenar">
          <ng-select
            (change)="changeOpt($event)"
            formControlName="order"
            class="form-control pt-1">
            <ng-option value="1">LOTE</ng-option>
            <ng-option value="2">REGIONAL</ng-option>
            <ng-option value="4">FOLIO</ng-option>
          </ng-select>
          <!-- <input type="text" class="form-control" formControlName="order" /> -->
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field
          [control]="formFactura.get('importE')"
          label="Importe Egresos">
          <input
            readonly
            type="text"
            class="form-control"
            currencyMask
            formControlName="importE"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formFactura.get('ivaE')" label="Iva Egresos">
          <input
            readonly
            type="text"
            class="form-control"
            currencyMask
            formControlName="ivaE"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formFactura.get('totalE')" label="Total Egresos">
          <input
            readonly
            type="text"
            class="form-control"
            currencyMask
            formControlName="totalE"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formFactura.get('count')" label="No. Factura">
          <input
            readonly
            type="number"
            class="form-control"
            formControlName="count"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field
          [control]="formFactura.get('importI')"
          label="Importe Ingresos">
          <input
            readonly
            type="text"
            class="form-control"
            currencyMask
            formControlName="importI"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formFactura.get('ivaI')" label="Iva Ingresos">
          <input
            readonly
            type="text"
            class="form-control"
            currencyMask
            formControlName="ivaI"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field
          [control]="formFactura.get('totalI')"
          label="Total Ingresos">
          <input
            readonly
            type="text"
            class="form-control"
            currencyMask
            formControlName="totalI"
            oninput="if(this.value.length > 20) this.value = this.value.slice(0, 20)" />
        </form-field>
      </div>
    </div>
  </form>

  <form class="form-material" [formGroup]="formDetalle">
    <div class="row pt-5">
      <div class="col-md-2">
        <form-field [control]="formFactura.get('count')" label="No. Registros">
          <input
            readonly
            type="number"
            class="form-control"
            formControlName="count"
            oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formDetalle.get('totalI')" label="Total Importe">
          <input
            type="text"
            readonly
            class="form-control"
            currencyMask
            formControlName="totalI"
            oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formDetalle.get('totalIva')" label="Total Iva">
          <input
            type="text"
            readonly
            class="form-control"
            currencyMask
            formControlName="totalIva"
            oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field [control]="formDetalle.get('total')" label="Total">
          <input
            type="text"
            readonly
            class="form-control"
            currencyMask
            formControlName="total"
            oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)" />
        </form-field>
      </div>
      <div class="col-md-2">
        <form-field
          [control]="formDetalle.get('countTotal')"
          label="Cantidad Total Bienes">
          <input
            type="number"
            readonly
            class="form-control"
            formControlName="countTotal"
            oninput="if(this.value.length > 11) this.value = this.value.slice(0, 11)" />
        </form-field>
      </div>
    </div>
  </form>

  <div class="row pt-3">
    <div class="col-12 d-flex justify-content-end pb-3">
      <div>
        <!-- <button
          tooltip=""
          containerClass="tooltip-style"
          [ngClass]="{ loading: btnLoadAU }"
          [disabled]="btnLoadAU"
          (click)="updateDetFact('AU')"
          type="button"
          class="btn btn-primary active btn-sm mr-2 mb-2">
          <span *ngIf="!btnLoadAU">AU</span>
        </button> -->
      </div>
      <div>
        <!-- <button
          [ngClass]="{ loading: btnLoadAP }"
          [disabled]="btnLoadAP"
          (click)="updateDetFact('AP')"
          type="button"
          class="btn btn-info active btn-sm mr-2 mb-2">
          <span *ngIf="!btnLoadAP">AP</span>
        </button> -->
      </div>
      <app-columns-select
        [(settings)]="settings2"
        [leftList]="true"></app-columns-select>
    </div>
    <form-loader *ngIf="loading2"></form-loader>
    <div>
      <ng2-smart-table
        [ngStyle]="{
          height: loading2 ? '0px' : totalItems2 > 10 ? '600px' : 'auto'
        }"
        [attr.class]="'table-bordered table-responsive mb-4'"
        (userRowSelect)="selectDataComerDetInvocie($event.data)"
        [settings]="settings2"
        [source]="dataFilter2">
      </ng2-smart-table>
    </div>
    <app-pagination
      [params]="paramsList2"
      [totalItems]="totalItems2"
      [limit]="limit"
      [pageSizeOptions]="[500]">
    </app-pagination>
  </div>
</div>
